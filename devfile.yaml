schemaVersion: 2.2.0
metadata:
  name: rust-development
  displayName: Rust Development Environment
  description: Prebuilt Rust + Nix dev container
  icon: https://www.rust-lang.org/logos/rust-logo-512x512.png
  tags:
    - Rust
    - Nix
  projectType: rust
  language: rust
  version: 1.0.0

projects:
  - name: rustling
    git:
      remotes:
        origin: https://github.com/Mbd06b/rustling.git
components:
  - name: rust-dev
    container:
      image: harbor.ethosengine.com/devspaces/rust-nix-dev:latest
      memoryLimit: 8Gi
      memoryRequest: 2Gi
      cpuLimit: '4'
      cpuRequest: '1'
      mountSources: true
      sourceMapping: /projects
      env:
        - name: CLAUDE_CONFIG_DIR
          value: /projects/.claude-config
        - name: RUST_BACKTRACE
          value: '1'
        - name: USER
          value: user
        # XDG directories now use /tmp (ephemeral) to avoid consuming PVC space
        # This matches the container's bashrc configuration
        - name: XDG_CACHE_HOME
          value: /tmp/nix-cache
        - name: XDG_DATA_HOME
          value: /tmp/nix-data
        - name: XDG_STATE_HOME
          value: /tmp/nix-state
        - name: XDG_CONFIG_HOME
          value: /tmp/nix-config
        - name: NPM_CONFIG_CACHE
          value: /tmp/nix-cache/npm
        - name: LANG
          value: en_US.UTF-8
        - name: LC_ALL
          value: en_US.UTF-8
        - name: NIX_CONFIG
          value: |
            experimental-features = nix-command flakes
            sandbox = false
            substituters = https://cache.nixos.org https://holochain-ci.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= holochain-ci.cachix.org-1:5IUSkZc0aoRS53rfkvH9Kid40NpyjwCMCzwRTXy+QN8=
            auto-optimise-store = true
            min-free = 5368709120
            max-free = 10737418240
            keep-outputs = false
            keep-derivations = false
      endpoints:
        - name: ui
          targetPort: 5173
          exposure: public
          protocol: https
        - name: playground
          targetPort: 8080
          exposure: public
          protocol: https
        - name: hc-admin-agent1
          targetPort: 8888
          exposure: public
          protocol: https
        - name: hc-app-agent1
          targetPort: 8890
          exposure: public
          protocol: https
        - name: hc-admin-agent2
          targetPort: 8892
          exposure: public
          protocol: https
        - name: hc-app-agent2
          targetPort: 8891
          exposure: public
          protocol: https
        - name: debug-5005
          targetPort: 5005
          exposure: internal
      volumeMounts:
        - name: cargo-cache
          path: /home/user/.cargo
        - name: rustup-cache
          path: /home/user/.rustup
        - name: nix-store
          path: /nix

  - name: cargo-cache
    volume:
      size: 3Gi
  - name: rustup-cache
    volume:
      size: 2Gi
  - name: nix-store
    volume:
      size: 15Gi

commands:
  - id: rust-init-project
    exec:
      label: "Initialize Rust Project"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: |
        cargo init --name my-rust-project
        echo "Rust project initialized!"

  - id: cargo-build
    exec:
      label: "Build Rust Project"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: cargo build
      group:
        kind: build
        isDefault: true

  - id: cargo-run
    exec:
      label: "Run Rust Project"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: cargo run
      group:
        kind: run
        isDefault: true

  - id: cargo-test
    exec:
      label: "Test Rust Project"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: cargo test
      group:
        kind: test
        isDefault: true

  - id: cargo-clippy
    exec:
      label: "Run Clippy Linter"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: cargo clippy -- -D warnings

  - id: cargo-fmt
    exec:
      label: "Format Code"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: cargo fmt

  - id: install-rust-book-examples
    exec:
      label: "Download Rust Book Examples"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: |
        git clone https://github.com/rust-lang/book.git rust-book-examples
        echo "Examples downloaded to rust-book-examples/"

  - id: nix-status
    exec:
      label: "Check Nix/Rust Status and Storage"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: nix-status

  - id: nix-clean
    exec:
      label: "Run Nix Garbage Collection"
      component: rust-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: nix-clean